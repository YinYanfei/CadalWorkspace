package cn.cadal.rec.data;

import java.io.FileWriter;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

public class GetMetadata {
	private String file = "E:/Recommendation/ExpData/cbookInfo.dat";
	
	public String bookNum;
	Connection con = null;
	public int errorFlag;

	// 构造函数
	public GetMetadata() {
		this.errorFlag = 0; // 正常情况为0;

		// 连数据库
		String Username = "cadal";      // 数据库用户名
		String userPasswd = "Cadal205"; // 密码
		String url = "jdbc:postgresql:" + "//10.15.62.71:5432/cadal_metadata_full_dbo2";

		// 加载驱动程序以连接数据库
		try {
			Class.forName("org.postgresql.Driver");
			System.out.println(url);
			con = DriverManager.getConnection(url, Username, userPasswd);
		} catch (ClassNotFoundException e) {
			e.printStackTrace();
		} catch (SQLException e) {
			e.printStackTrace();
		}
	}
	
	/**
	 * main函数从数据库里面得到相关的数据，然后存入文件
	 * 详细的代码在231服务器上
	 * @param args
	 */
	public void MetaData() {
		// 对应数据库的字段
		String BookNo= "";
		String Title= "";
		String Creator= "";
		String Publisher= "";
		String Relation= "";
		String Type="";
		
		int num = 0;
		
		try{
			Statement statement = this.con.createStatement();
			String sql = "SELECT \"BookNo\", \"Title\", \"Creator\", \"Publisher\", \"Relation\", \"Type\" FROM \"cbook\"";
			ResultSet rs = statement.executeQuery(sql);
			
			// 文件打开
			FileWriter writerAudio = new FileWriter(this.file, true);
			
			System.out.println("Files Created, DB Connecting.");
			
			if (!rs.next()) {
				System.out.println("No result");
			}else{
				do {
					BookNo = rs.getString("BookNo");
					Title = rs.getString("Title");
					Creator = rs.getString("Creator");
					Publisher = rs.getString("Publisher");
					Relation = rs.getString("Relation");
					Type = rs.getString("Type");
					
					// 写入文件
					writerAudio.write(
							BookNo + " #### " + 
							Title.replaceAll("\n", " | ") + " #### " + 
							Creator.replaceAll("\n", " | ") + " #### " + 
							Publisher.replaceAll("\n", " | ") + " #### " + 
							Relation.replaceAll("\n", " | ") + " #### " +
							Type.replaceAll("\n", "|") + "\n"
					);

					// 计数
					++num;
				} while (rs.next());
			}
			
			System.out.println(num);
			
			// 文件关闭
			writerAudio.close();
			
		}catch(Exception e) {
			e.printStackTrace();
		} 
	}

}
