package cn.cadal.rec.algo.sgd;

import java.io.*;
import java.util.Properties;
import java.util.Random;
import java.lang.Math;

public class LFM {
	public static void main(String[] args) throws Exception {
		RandomAccessFile input = new RandomAccessFile("E:/Recommendation/LFM/test.txt","r");
		Properties props = new Properties();
		File propFile = new File("E:/Recommendation/LFM/properties.txt");
		if (propFile.exists()) {
			FileReader in = new FileReader(propFile);
			props.load(in);
			in.close();
		}
		
		int iters = Integer.parseInt(props.getProperty("iters", "15"));
		int numLatent = Integer.parseInt(props.getProperty("numLatent", "10"));
		Float stepSize = Float.parseFloat(props.getProperty("stepSize", "0.1"));
		Float stepRate = Float.parseFloat(props.getProperty("stepRate", "0.8"));
		Float penalty = Float.parseFloat(props.getProperty("penalty", "0.1"));
		int numUser = Integer.parseInt(props.getProperty("numUser", "7000")) + 1;
		int numItem = Integer.parseInt(props.getProperty("numItem", "4000")) + 1;

		String line = input.readLine();
		String token[];
		int userId,itemId,sum = 0;
		Float rating,tmp,bias = 0F;
		while(line != null){
			token = line.split(" ");
			userId = Integer.parseInt(token[0]);
			itemId = Integer.parseInt(token[1]);
			rating = Float.parseFloat(token[2]);
			tmp = 0F;
			for(int i = 0; i < numLatent; i++)
				tmp += matrixUser[userId][i] * matrixItem[itemId][i];
			tmp -= rating;
			bias += tmp * tmp;
			sum++;
			line = input.readLine();
		}
		input.close();
		System.out.println(Math.sqrt(bias/sum));
		long endTime = System.currentTimeMillis();
		System.out.println("times = " + (endTime - startTime)/1000+"s");
		
		BufferedWriter log = new BufferedWriter(new FileWriter("E:/Recommendation/LFM/log.txt",true));
		line = "iters="+iters+" numLatent="+numLatent+" stepRate="+stepRate
				+" RMSE="+Math.sqrt(bias/sum)+" times="+(endTime - startTime)/1000+"s\n";
		log.write(line);
		log.close();
	}
}


